#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Cria a resposta HTML em um buffer maior
char html[32768]; // 32KB - tamanho para HTML completo

void preencher_html() {
    snprintf(html, sizeof(html),
        "HTTP/1.1 200 OK\r\n"
        "Content-Type: text/html\r\n"
        "\r\n"
        "<!DOCTYPE html>\n"
        "<html lang=\"pt-BR\">\n"
        "<head>\n"
        "    <meta charset=\"UTF-8\">\n"
        "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n"
        "    <title>Painel de Controle - Armazém XYZ</title>\n"
        "    <style>\n"
        "        :root{--cor-primaria:#005A9C;--cor-fundo:#f4f7f9;--cor-painel:#ffffff;--cor-texto:#333333;--cor-sucesso:#28a745;--cor-aviso:#ffc107;--cor-borda:#dee2e6;--sombra-suave:0 4px 8px rgba(0,0,0,0.05)}\n"
        "        *{margin:0;padding:0;box-sizing:border-box}\n"
        "        body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif;background-color:var(--cor-fundo);color:var(--cor-texto);line-height:1.6}\n"
        "        .main-header,.main-footer{background-color:var(--cor-primaria);color:white;padding:1rem 2rem;text-align:center}\n"
        "        .dashboard-container{display:flex;flex-wrap:wrap;padding:1.5rem;gap:1.5rem}\n"
        "        .warehouse-view-column{flex:2;min-width:350px}\n"
        "        .controls-column{flex:1;min-width:300px}\n"
        "        section{background-color:var(--cor-painel);padding:1.5rem;border-radius:8px;box-shadow:var(--sombra-suave);margin-bottom:1.5rem}\n"
        "        h2,h3{margin-bottom:1rem;color:var(--cor-primaria)}\n"
        "        h3{font-size:1.1rem;border-bottom:1px solid var(--cor-borda);padding-bottom:.5rem}\n"
        "        .warehouse-layout{display:flex;align-items:center;justify-content:center;gap:1rem}\n"
        "        .rack-container{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;flex-grow:1}\n"
        "        .rack-cell{background-color:#e9ecef;border:1px solid #ccc;border-radius:4px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.9rem;transition:background-color .3s ease,transform .2s ease;cursor:pointer}\n"
        "        .rack-cell.occupied{background-color:var(--cor-aviso);color:var(--cor-texto);border-color:#e6a800}\n"
        "        .rack-cell:hover{transform:scale(1.05)}\n"
        "        .legend{display:flex;justify-content:center;gap:2rem;margin-top:1rem;padding:1rem;background-color:#f8f9fa;border-radius:4px}\n"
        "        .legend-item{display:flex;align-items:center;gap:.5rem}\n"
        "        .legend-color{width:20px;height:20px;border-radius:4px;border:1px solid #ccc}\n"
        "        .legend-color.occupied{background-color:var(--cor-aviso)}\n"
        "        .legend-color.empty{background-color:#e9ecef}\n"
        "        .conveyor{border:2px dashed var(--cor-primaria);padding:1rem .5rem;min-height:200px;display:flex;flex-direction:column;align-items:center;text-align:center}\n"
        "        .pallet-info{margin-top:1rem;font-weight:bold;color:var(--cor-sucesso)}\n"
        "        .control-group{margin-bottom:2rem}\n"
        "        form{display:flex;flex-direction:column;gap:.75rem}\n"
        "        input[type=\"text\"],input[type=\"number\"],input[type=\"date\"],select{width:100%;padding:.75rem;border:1px solid var(--cor-borda);border-radius:4px;font-size:1rem;background-color:white;}\n"
        "        button{padding:.75rem 1rem;border:none;border-radius:4px;background-color:var(--cor-primaria);color:white;font-size:1rem;font-weight:bold;cursor:pointer;transition:background-color .2s ease}\n"
        "        button:hover{background-color:#004a80}\n"
        "        button.storage-active{background-color:var(--cor-sucesso)}\n"
        "        button.storage-active:hover{background-color:#218838}\n"
        "        #electromagnet-control{margin-top:1rem;display:flex;align-items:center;gap:1rem}\n"
        "        #log-container{background-color:#f8f9fa;border:1px solid var(--cor-borda);border-radius:4px;padding:1rem;height:150px;overflow-y:auto;font-family:\"Courier New\",monospace;font-size:.9rem}\n"
        "        #log-container p{padding-bottom:.5rem;border-bottom:1px solid #eee}\n"
        "        #log-container p:last-child{border-bottom:none}\n"
        "        .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}\n"
        "        .popup{background-color:white;padding:2rem;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.3);text-align:center;max-width:400px;width:90%}\n"
        "        .popup h3{margin-bottom:1rem;color:var(--cor-primaria)}\n"
        "        .popup-buttons{display:flex;gap:1rem;justify-content:center;margin-top:1.5rem}\n"
        "        .popup-buttons button{padding:.5rem 1.5rem}\n"
        "        .popup-buttons button.cancel{background-color:#6c757d}\n"
        "        .popup-buttons button.cancel:hover{background-color:#5a6268}\n"
        "    </style>\n"
        "</head>\n"
        "<body>\n"
        "    <header class=\"main-header\"><h1>Painel de Controle - Armazém Automatizado XYZ</h1></header>\n"
        "    <main class=\"dashboard-container\">\n"
        "        <div class=\"warehouse-view-column\">\n"
        "            <section id=\"visualizacao-rack\">\n"
        "                <h2>Layout do Armazém</h2>\n"
        "                <div class=\"warehouse-layout\">\n"
        "                    <div id=\"entry-conveyor\" class=\"conveyor\"><h3>Entrada</h3><div class=\"pallet-info\" id=\"pallet-on-entry\"><p>Pallet de Entrada</p></div></div>\n"
        
        // "                    \n"
        "                    <div class=\"rack-container\">\n"
        "                        <div class=\"rack-cell\" data-position=\"A1\">A1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B1\">B1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C1\">C1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"A2\">A2</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B2\">B2</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C2\">C2</div>\n"
        "                    </div>\n"
        // "                    \n"

        "                    <div id=\"exit-conveyor\" class=\"conveyor\"><h3>Saída</h3><div class=\"pallet-info\" id=\"pallet-on-exit\"></div></div>\n"
        "                </div>\n"
        "                <div class=\"legend\">\n"
        "                    <div class=\"legend-item\"><div class=\"legend-color occupied\"></div><span>Ocupado</span></div>\n"
        "                    <div class=\"legend-item\"><div class=\"legend-color empty\"></div><span>Vazio</span></div>\n"
        "                </div>\n"
        "            </section>\n"
        "        </div>\n"
        "        <div class=\"controls-column\">\n"
        "            <section id=\"painel-controle\">\n"
        "                <h2>Painel de Controle</h2>\n"
        "                <div class=\"control-group\" id=\"pallet-operations\">\n"
        "                    <h3>Operações com Pallets</h3>\n"
        "                    <form id=\"store-form\">\n"
        "                        <p>Armazenar pallet da esteira de entrada.</p>\n"
        "                        \n"
        "                        <label for=\"product-select\">Produto a ser armazenado:</label>\n"
        "                        <select id=\"product-select\" name=\"product\" required>\n"
        "                            <option value=\"\" disabled selected>Carregando produtos...</option>\n"
        "                        </select>\n"
        "                        <button type=\"button\">Iniciar Armazenamento</button>\n"
        "                    </form>\n"
        "                </div>\n"
        "                <div class=\"control-group\" id=\"manual-control\">\n"
        "                     <h3>Controle Manual</h3>\n"
        "                    <div id=\"electromagnet-control\"><button id=\"electromagnet-toggle-btn\">Ativar Eletroímã</button><span>Status: <b id=\"electromagnet-status\">Desativado</b></span></div>\n"
        "                    <div style=\"margin-top:1rem;\"><button id=\"home-btn\" style=\"background-color:#eb3434;\">Retornar ao Home (0,0,0)</button></div>\n"
        "                </div>\n"
        "            </section>\n"
        "            <section id=\"historico\">\n"
        "                <h2>Histórico de Movimentações</h2>\n"
        "                \n"
        "                <div id=\"log-container\"><p>Iniciando sistema...</p></div>\n"
        "            </section>\n"
        "        </div>\n"
        "    </main>\n"
        "    <div class=\"popup-overlay\" id=\"popup-overlay\">\n"
        "        <div class=\"popup\">\n"
        "            <h3 id=\"popup-title\"></h3>\n"
        "            <p id=\"popup-message\"></p>\n"
        "            <div class=\"popup-buttons\">\n"
        "                <button id=\"popup-confirm-btn\">Sim</button>\n"
        "                <button class=\"cancel\" id=\"popup-cancel-btn\">Não</button>\n"
        "            </div>\n"
        "        </div>\n"
        "    </div>\n"
        "    <footer class=\"main-footer\"><p>Interface de Controle v1.0 - Status do Sistema: <span id=\"system-status\">Online</span></p></footer>\n"
        "    <script>\n"
        "        // [NOVO] Endereço do servidor de Banco de Dados (onde o Python roda)\n"
        "        // !! IMPORTANTE: Troque 'DB_SERVER_URL' pelo IP real do seu PC !!\n"
        "        const DB_SERVER_URL = 'http://192.168.1.9:5000';\n"
        "\n"
        "        // Função de log para o servidor Python (seu código original)\n"
        "        function sendLogToServer(message, level='INFO') {\n"
        "            if (!DB_SERVER_URL) return;\n"
        "            try {\n"
        "                fetch(DB_SERVER_URL + '/api/log', {\n"
        "                    method: 'POST',\n"
        "                    headers: { 'Content-Type': 'application/json' },\n"
        "                    body: JSON.stringify({ message: message, level: level })\n"
        "                }).catch(err => {\n"
        "                    console.error('Erro ao enviar log ao servidor', err);\n"
        "                });\n"
        "            } catch (e) { console.error('sendLogToServer exception', e); }\n"
        "        }\n"
        "\n"
        "        let historyLog = [];\n"
        "        let pendingOperation = null; // [NOVO] Guarda a operação pendente (ex: {action: 'store', product: 'Açúcar', slot: 'A1'})\n"
        "        let lastLogCount = 0; // [NOVO] Para saber qual foi o último log lido do Pico\n"
        "\n"
        "        document.addEventListener('DOMContentLoaded', function () {\n"
        "            const rackCells = document.querySelectorAll('.rack-cell');\n"
        "            const popupOverlay = document.getElementById('popup-overlay');\n"
        "            const popupTitle = document.getElementById('popup-title');\n"
        "            const popupMessage = document.getElementById('popup-message');\n"
        "            const confirmButton = document.getElementById('popup-confirm-btn');\n"
        "            const cancelButton = document.getElementById('popup-cancel-btn');\n"
        "            const electromagnetBtn = document.getElementById('electromagnet-toggle-btn');\n"
        "            const electromagnetStatus = document.getElementById('electromagnet-status');\n"
        "            const storeButton = document.querySelector('#store-form button');\n"
        "            const productSelect = document.getElementById('product-select'); // [NOVO]\n"
        "            const homeBtn = document.getElementById('home-btn');\n"
        "            \n"
        "            let currentSlot = null;\n"
        "            let currentAction = '';\n"
        "            let isStorageModeActive = false;\n"
        "            let electromagnetActive = false;\n"
        "\n"
        "            // --- INICIALIZAÇÃO ---\n"
        "            initializeHistory();\n"
        "            updateElectromagnetStatus();\n"
        "            loadProducts(); // [NOVO] Carrega os produtos do DB Python\n"
        "            setInterval(updateElectromagnetStatus, 5000);\n"
        "            setInterval(pollPicoLog, 2000); // [NOVO] Começa a monitorar o log do Pico\n"
        "\n"
        "            // --- LÓGICA DE CLIQUE NAS CÉLULAS ---\n"
        "            rackCells.forEach(cell => {\n"
        "                cell.addEventListener('click', function () {\n"
        "                    currentSlot = this.getAttribute('data-position');\n"
        "                    if (this.classList.contains('occupied')) {\n"
        "                        // --- LÓGICA DE RETIRADA ---\n"
        "                        currentAction = 'retrieve';\n"
        "                        popupTitle.textContent = 'Confirmar Remoção';\n"
        "                        popupMessage.innerHTML = `Deseja remover o pallet da posição <strong>${currentSlot}</strong>?`;\n"
        "                        popupOverlay.style.display = 'flex';\n"
        "                    } else {\n"
        "                        // --- LÓGICA DE ARMAZENAMENTO ---\n"
        "                        if (isStorageModeActive && pendingOperation && pendingOperation.action === 'store') {\n"
        "                            currentAction = 'store';\n"
        "                            pendingOperation.slot = currentSlot; // [NOVO] Agora sabemos o slot\n"
        "                            popupTitle.textContent = 'Confirmar Armazenamento';\n"
        "                            popupMessage.innerHTML = `Armazenar <strong>${pendingOperation.product}</strong> na posição <strong>${currentSlot}</strong>?`;\n"
        "                            popupOverlay.style.display = 'flex';\n"
        "                        } else {\n"
        "                            addToHistory(\"Aviso: Para armazenar, selecione um produto e clique em 'Iniciar Armazenamento' primeiro.\");\n"
        "                        }\n"
        "                    }\n"
        "                });\n"
        "            });\n"
        "\n"
        "            // [MODIFICADO] Botão de Armazenamento agora define o produto\n"
        "            storeButton.addEventListener('click', function () {\n"
        "                if (isStorageModeActive) {\n"
        "                    // Cancelar modo de armazenamento\n"
        "                    isStorageModeActive = false;\n"
        "                    pendingOperation = null;\n"
        "                    this.textContent = 'Iniciar Armazenamento';\n"
        "                    this.classList.remove('storage-active');\n"
        "                    productSelect.disabled = false;\n"
        "                    addToHistory(\"Modo de armazenamento ENCERRADO.\");\n"
        "                } else {\n"
        "                    // Iniciar modo de armazenamento\n"
        "                    const selectedProduct = productSelect.value;\n"
        "                    if (!selectedProduct) {\n"
        "                        addToHistory(\"ERRO: Selecione um produto antes de iniciar.\");\n"
        "                        return;\n"
        "                    }\n"
        "                    isStorageModeActive = true;\n"
        "                    pendingOperation = { action: 'store', product: selectedProduct, slot: null }; // [NOVO] Guarda o produto\n"
        "                    this.textContent = 'Selecione um slot vazio...';\n"
        "                    this.classList.add('storage-active');\n"
        "                    productSelect.disabled = true;\n"
        "                    addToHistory(`Modo de armazenamento ATIVADO para: ${selectedProduct}.`);\n"
        "                }\n"
        "            });\n"
        "\n"
        "            // [MODIFICADO] Botão de Confirmação do Popup\n"
        "            confirmButton.addEventListener('click', function () {\n"
        "                if (currentSlot && currentAction) {\n"
        "                    const cellElement = document.querySelector(`[data-position=\"${currentSlot}\"]`);\n"
        "                    if (currentAction === 'retrieve') {\n"
        "                        // [NOVO] Define a operação pendente para a lógica de 'poll'\n"
        "                        pendingOperation = { action: 'retrieve', slot: currentSlot }; \n"
        "                        fetch(`/retrieve?slot=${currentSlot}`, { method: 'POST' }).then(handleResponse).catch(handleError);\n"
        "                        addToHistory(`Retirada da posicao ${currentSlot} solicitada.`);\n"
        "                        // A remoção da classe 'occupied' será feita pelo 'processPicoLog' após confirmação\n"
        "                    } else if (currentAction === 'store' && pendingOperation) {\n"
        "                        // 'pendingOperation' já foi definido. Apenas enviamos o comando para o Pico.\n"
        "                        fetch(`/store?slot=${currentSlot}`, { method: 'POST' }).then(handleResponse).catch(handleError);\n"
        "                        addToHistory(`Armazenamento de ${pendingOperation.product} em ${currentSlot} solicitado.`);\n"
        "                        // A adição da classe 'occupied' será feita pelo 'processPicoLog'\n"
        "                    }\n"
        "                }\n"
        "                closePopup();\n"
        "            });\n"
        "\n"
        "            // --- FUNÇÕES DE REDE (PICO) ---\n"
        "            function handleResponse(response) {\n"
        "                if (!response.ok) {\n"
        "                    addToHistory(`ERRO na operação em ${currentSlot}.`);\n"
        "                    pendingOperation = null; // [NOVO] Cancela a operação pendente\n"
        "                }\n"
        "            }\n"
        "            function handleError(error) {\n"
        "                console.error('Erro de conexão:', error);\n"
        "                addToHistory(`ERRO de conexão na operação em ${currentSlot}.`);\n"
        "                pendingOperation = null; // [NOVO] Cancela a operação pendente\n"
        "            }\n"
        "\n"
        "            // --- FUNÇÕES DO POPUP (Sem mudanças) ---\n"
        "            function closePopup() {\n"
        "                popupOverlay.style.display = 'none';\n"
        "                currentSlot = null;\n"
        "                currentAction = '';\n"
        "                // Não limpa 'pendingOperation' aqui\n"
        "            }\n"
        "            cancelButton.addEventListener('click', () => {\n"
        "                closePopup();\n"
        "                if(pendingOperation && pendingOperation.action === 'store') {\n"
        "                    pendingOperation.slot = null; // Permite escolher outro slot\n"
        "                }\n"
        "            });\n"
        "            popupOverlay.addEventListener('click', (e) => { if (e.target === popupOverlay) { closePopup(); }});\n"
        "\n"
        "            // --- CONTROLES MANUAIS (Sem mudanças) ---\n"
        "            electromagnetBtn.addEventListener('click', function () {\n"
        "                fetch('/toggle-electromagnet', { method: 'POST' })\n"
        "                    .then(response => {\n"
        "                        if (response.ok) {\n"
        "                            electromagnetActive = !electromagnetActive;\n"
        "                            updateElectromagnetBtn(electromagnetActive);\n"
        "                            addToHistory(`Eletroima ${electromagnetActive ? 'ativado' : 'desativado'}.`);\n"
        "                        } else {\n"
        "                            addToHistory('ERRO: Falha ao comunicar com o eletroímã.');\n"
        "                        }\n"
        "                    }).catch(err => addToHistory('ERRO: Não foi possível conectar ao servidor.'));\n"
        "            });\n"
        "            homeBtn.addEventListener('click', function () {\n"
        "                if (confirm('Deseja retornar os eixos ao ponto inicial (0,0,0)?')) {\n"
        "                    fetch('/home', { method: 'POST' })\n"
        "                        .then(response => {\n"
        "                            if (response.ok) addToHistory('Comando de retorno ao home (0,0,0) enviado.');\n"
        "                            else addToHistory('ERRO: Falha ao enviar comando de home.');\n"
        "                        }).catch(err => addToHistory('ERRO: Não foi possível conectar ao servidor.'));\n"
        "                }\n"
        "            });\n"
        "            function updateElectromagnetStatus() {\n"
        "                fetch('/api/electromagnet-status')\n"
        "                    .then(response => response.json())\n"
        "                    .then(data => updateElectromagnetBtn(data.active))\n"
        "                    .catch(error => console.error('Erro ao obter status do eletroímã:', error));\n"
        "            }\n"
        "            function updateElectromagnetBtn(isActive) {\n"
        "                electromagnetActive = isActive;\n"
        "                const newStatus = isActive ? 'Ativado' : 'Desativado';\n"
        "                electromagnetStatus.textContent = newStatus;\n"
        "                electromagnetBtn.textContent = isActive ? 'Desativar Eletroímã' : 'Ativar Eletroímã';\n"
        "            }\n"
        "\n"
        "            // --- FUNÇÕES DE LOG (PICO) E ORQUESTRAÇÃO [NOVAS] ---\n"
        "            function pollPicoLog() {\n"
        "                fetch('/api/history') // Busca o log do PICO\n"
        "                    .then(response => response.json())\n"
        "                    .then(data => {\n"
        "                        if (data.length > lastLogCount) {\n"
        "                            const newLogs = data.slice(lastLogCount);\n"
        "                            newLogs.forEach(log => {\n"
        "                                addToHistory(`[PICO] ${log}`); // Adiciona log do Pico na UI\n"
        "                                processPicoLog(log); // Processa o log para orquestração\n"
        "                            });\n"
        "                            lastLogCount = data.length;\n"
        "                        }\n"
        "                    })\n"
        "                    .catch(err => console.error('Falha ao pollar log do Pico:', err));\n"
        "            }\n"
        "\n"
        "            function processPicoLog(logMessage) {\n"
        "                if (!pendingOperation) return; // Nenhuma operação aguardando\n"
        "\n"
        "                // Tenta dar 'match' com a regex de SUCESSO DE ARMAZENAMENTO\n"
        "                // Ex: 'Pallet [12 34 56 78] guardado em A1.'\n"
        "                const storeRegex = /Pallet \\[(.+)\\] guardado em (\\S+)\\./;\n"
        "                let match = logMessage.match(storeRegex);\n"
        "                if (match && pendingOperation.action === 'store' && match[2] === pendingOperation.slot) {\n"
        "                    const uid = match[1];\n"
        "                    const product = pendingOperation.product;\n"
        "                    const slot = pendingOperation.slot;\n"
        "                    addToHistory(`Pico confirmou: UID [${uid}] guardado em ${slot}.`);\n"
        "                    \n"
        "                    // PASSO FINAL: Registra no DB Python\n"
        "                    registerPalletInDB(uid, product);\n"
        "                    \n"
        "                    // Atualiza a UI\n"
        "                    const cellElement = document.querySelector(`[data-position=\"${slot}\"]`);\n"
        "                    if (cellElement) cellElement.classList.add('occupied');\n"
        "                    resetStorageMode(); // Reseta o formulário de storage\n"
        "                    return;\n"
        "                }\n"
        "\n"
        "                // Tenta dar 'match' com a regex de SUCESSO DE RETIRADA\n"
        "                // Ex: 'Pallet [88 77 66 55] detectado em B2. Retirando.'\n"
        "                const retrieveRegex = /Pallet \\[(.+)\\] detectado em (\\S+)\\. Retirando\\./;\n"
        "                match = logMessage.match(retrieveRegex);\n"
        "                if (match && pendingOperation.action === 'retrieve' && match[2] === pendingOperation.slot) {\n"
        "                    const uid = match[1];\n"
        "                    const slot = pendingOperation.slot;\n"
        "                    addToHistory(`Pico confirmou: UID [${uid}] retirado de ${slot}.`);\n"
        "                    \n"
        "                    // PASSO FINAL: Apenas informa o que foi retirado (opcional)\n"
        "                    getPalletInfoFromDB(uid);\n"
        "\n"
        "                    // Atualiza a UI\n"
        "                    const cellElement = document.querySelector(`[data-position=\"${slot}\"]`);\n"
        "                    if (cellElement) cellElement.classList.remove('occupied');\n"
        "                    pendingOperation = null; // Completa a operação\n"
        "                    return;\n"
        "                }\n"
        "\n"
        "                // Tenta dar 'match' com a regex de ERRO (Slot Ocupado/Vazio)\n"
        "                const errorRegex = /ERRO: Slot (\\S+) esta (OCUPADO|VAZIO)/;\n"
        "                match = logMessage.match(errorRegex);\n"
        "                if (match && match[1] === pendingOperation.slot) {\n"
        "                    addToHistory(`FALHA: Operação em ${pendingOperation.slot} abortada pelo Pico.`);\n"
        "                    resetStorageMode(); // Reseta o formulário de storage\n"
        "                }\n"
        "            }\n"
        "            \n"
        "            function resetStorageMode() {\n"
        "                isStorageModeActive = false;\n"
        "                pendingOperation = null;\n"
        "                storeButton.textContent = 'Iniciar Armazenamento';\n"
        "                storeButton.classList.remove('storage-active');\n"
        "                productSelect.disabled = false;\n"
        "            }\n"
        "\n"
        "            // --- FUNÇÕES DE REDE (DB PYTHON) [NOVAS] ---\n"
        "            function loadProducts() {\n"
        "                fetch(DB_SERVER_URL + '/api/products')\n"
        "                    .then(response => response.json())\n"
        "                    .then(products => {\n"
        "                        productSelect.innerHTML = ''; // Limpa o 'Carregando...'\n"
        "                        if (products.length === 0) {\n"
        "                            productSelect.innerHTML = '<option value=\"\" disabled>Nenhum produto cadastrado</option>';\n"
        "                            return;\n"
        "                        }\n"
        "                        products.forEach(product => {\n"
        "                            const option = document.createElement('option');\n"
        "                            option.value = product.name;\n"
        "                            option.textContent = `${product.name} (Qtd: ${product.default_quantity})`;\n"
        "                            productSelect.appendChild(option);\n"
        "                        });\n"
        "                    })\n"
        "                    .catch(err => {\n"
        "                        console.error('Erro ao carregar produtos:', err);\n"
        "                        productSelect.innerHTML = '<option value=\"\" disabled>Erro ao carregar</option>';\n"
        "                        addToHistory('ERRO: Falha ao conectar ao servidor de banco de dados.');\n"
        "                    });\n"
        "            }\n"
        "\n"
        "            function registerPalletInDB(uid, productName) {\n"
        "                fetch(DB_SERVER_URL + '/api/pallet/register', {\n"
        "                    method: 'POST',\n"
        "                    headers: { 'Content-Type': 'application/json' },\n"
        "                    body: JSON.stringify({ uid: uid, product_name: productName })\n"
        "                })\n"
        "                .then(response => response.json())\n"
        "                .then(data => {\n"
        "                    if (data.status === 'success') {\n"
        "                        addToHistory(`DB: Pallet [${uid}] registrado como '${productName}'.`);\n"
        "                    } else {\n"
        "                        addToHistory(`ERRO DB: Falha ao registrar [${uid}]. ${data.error}`);\n"
        "                    }\n"
        "                })\n"
        "                .catch(err => {\n"
        "                    console.error('Erro ao registrar pallet:', err);\n"
        "                    addToHistory('ERRO: Falha ao conectar ao DB para registrar pallet.');\n"
        "                });\n"
        "            }\n"
        "\n"
        "            function getPalletInfoFromDB(uid) {\n"
        "                fetch(DB_SERVER_URL + '/api/pallet/' + encodeURIComponent(uid))\n"
        "                .then(response => response.json())\n"
        "                .then(data => {\n"
        "                    if (data.product_name) {\n"
        "                        addToHistory(`INFO: Pallet retirado [${uid}] é '${data.product_name}' (Qtd: ${data.current_quantity}).`);\n"
        "                    } else {\n"
        "                        addToHistory(`AVISO: Pallet retirado [${uid}] não foi encontrado no DB.`);\n"
        "                    }\n"
        "                })\n"
        "                .catch(err => {\n"
        "                    console.error('Erro ao buscar info do pallet:', err);\n"
        "                    addToHistory('ERRO: Falha ao conectar ao DB para buscar info.');\n"
        "                });\n"
        "            }\n"
        "\n"
        "            // --- FUNÇÕES DE LOG (UI) ---\n"
        "            function initializeHistory() { historyLog = []; }\n"
        "            function addToHistory(message) {\n"
        "                const now = new Date();\n"
        "                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;\n"
        "                const logEntry = `${time} - ${message}`;\n"
        "                historyLog.unshift(logEntry);\n"
        "                if (historyLog.length > 50) historyLog.pop(); // Limita o log\n"
        "                updateHistoryDisplay();\n"
        "                // Envia o log da UI para o servidor de logs (assíncrono)\n"
        "                if (!message.startsWith('[PICO]')) { // Evita eco\n"
        "                    try { sendLogToServer(logEntry, 'INFO'); } catch(e) { console.error('sendLog error', e); }\n"
        "                }\n"
        "            }\n"
        "            function updateHistoryDisplay() {\n"
        "                const logContainer = document.getElementById('log-container');\n"
        "                logContainer.innerHTML = '';\n"
        "                historyLog.forEach(entry => {\n"
        "                    const p = document.createElement('p');\n"
        "                    p.textContent = entry;\n"
        "                    logContainer.appendChild(p);\n"
        "                });\n"
        "            }\n"
        "        });\n"
        "    </script>\n"
        "</body>\n"
        "</html>\n"
    );
}