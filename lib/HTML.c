#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Cria a resposta HTML em um buffer maior
char html[32768]; // 32KB - tamanho para HTML completo

void preencher_html() {
    snprintf(html, sizeof(html),
        "HTTP/1.1 200 OK\r\n"
        "Content-Type: text/html\r\n"
        "\r\n"
        "<!DOCTYPE html>\n"
        "<html lang=\"pt-BR\">\n"
        "<head>\n"
        "    <meta charset=\"UTF-8\">\n"
        "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n"
        "    <title>Painel de Controle - Armaz√©m XYZ</title>\n"
        "    \n"
        "    <style>\n"
        "        :root {\n"
        "            --cor-primaria: #005A9C;\n"
        "            --cor-fundo: #f4f7f9;\n"
        "            --cor-painel: #ffffff;\n"
        "            --cor-texto: #333333;\n"
        "            --cor-sucesso: #28a745;\n"
        "            --cor-aviso: #ffc107;\n"
        "            --cor-borda: #dee2e6;\n"
        "            --sombra-suave: 0 4px 8px rgba(0,0,0,0.05);\n"
        "        }\n"
        "\n"
        "        body, section, .main-header, .main-footer, input, button, .legend, #log-container, .rack-cell {\n"
        "            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;\n"
        "        }\n"
        "\n"
        "        body.dark-mode {\n"
        "            --cor-primaria: #2e86de;\n"
        "            --cor-fundo: #121212;\n"
        "            --cor-painel: #1e1e2e;\n"
        "            --cor-texto: #e2e2e2;\n"
        "            --cor-borda: #4a4a5e;\n"
        "            --sombra-suave: 0 4px 12px rgba(0,0,0,0.2);\n"
        "        }\n"
        "\n"
        "        *{margin:0;padding:0;box-sizing:border-box}\n"
        "        body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif;background-color:var(--cor-fundo);color:var(--cor-texto);line-height:1.6}\n"
        "        \n"
        "        .main-header {\n"
        "            background-color: var(--cor-primaria);\n"
        "            color: white;\n"
        "            padding: 1rem 2rem;\n"
        "            text-align: center;\n"
        "            position: relative;\n"
        "        }\n"
        "\n"
        "        #theme-toggle-btn {\n"
        "            position: absolute;\n"
        "            top: 50%;\n"
        "            right: 1.5rem;\n"
        "            transform: translateY(-50%);\n"
        "            background: rgba(255, 255, 255, 0.1);\n"
        "            border: 1px solid rgba(255, 255, 255, 0.5);\n"
        "            color: white;\n"
        "            width: 40px;\n"
        "            height: 40px;\n"
        "            border-radius: 50%;\n"
        "            font-size: 1.2rem;\n"
        "            cursor: pointer;\n"
        "            display: flex;\n"
        "            align-items: center;\n"
        "            justify-content: center;\n"
        "        }\n"
        "        #theme-toggle-btn:hover {\n"
        "            background-color: rgba(255, 255, 255, 0.2);\n"
        "        }\n"
        "        \n"
        "        body.dark-mode .rack-cell:not(.occupied) { background-color: #3a3a4e; border-color: #555; }\n"
        "        body.dark-mode .legend, body.dark-mode #log-container { background-color: #252535; }\n"
        "        body.dark-mode input { background-color: #3a3a4e; color: var(--cor-texto); border-color: var(--cor-borda); }\n"
        "        body.dark-mode .popup { background-color: var(--cor-painel); }\n"
        "\n"
        "        .main-footer {background-color: var(--cor-primaria);color: white;padding: 1rem 2rem;text-align: center;}\n"
        "        .dashboard-container {display: flex;flex-wrap: wrap; padding: 1.5rem;gap: 1.5rem;}\n"
        "        .warehouse-view-column {flex: 2; min-width: 350px;}\n"
        "        .controls-column {flex: 1; min-width: 300px;}\n"
        "        section {background-color: var(--cor-painel);padding: 1.5rem;border-radius: 8px;box-shadow: var(--sombra-suave);margin-bottom: 1.5rem;}\n"
        "        h2, h3 {margin-bottom: 1rem;color: var(--cor-primaria);}\n"
        "        h3 {font-size: 1.1rem;border-bottom: 1px solid var(--cor-borda);padding-bottom: 0.5rem;}\n"
        "        .warehouse-layout {display: flex;align-items: center;justify-content: center;gap: 1rem;}\n"
        "        .rack-container {display: grid;grid-template-columns: repeat(5, 1fr);gap: 0.5rem;flex-grow: 1;}\n"
        "        .rack-cell {background-color: #e9ecef;border: 1px solid #ccc;border-radius: 4px;aspect-ratio: 1 / 1; display: flex;align-items: center;justify-content: center;font-weight: bold;font-size: 0.9rem;cursor: pointer;}\n"
        "        .rack-cell.occupied {background-color: var(--cor-aviso);color: #333;border-color: #e6a800;}\n"
        "        .rack-cell.occupied:hover {background-color: #e6a800;transform: scale(1.05);}\n"
        "        .rack-cell:not(.occupied) {cursor: not-allowed;opacity: 0.6;}\n"
        "        .legend {display: flex;justify-content: center;gap: 2rem;margin-top: 1rem;padding: 1rem;background-color: #f8f9fa;border-radius: 4px;}\n"
        "        .legend-item {display: flex;align-items: center;gap: 0.5rem;}\n"
        "        .legend-color {width: 20px;height: 20px;border-radius: 4px;border: 1px solid #ccc;}\n"
        "        .legend-color.occupied {background-color: var(--cor-aviso);}\n"
        "        .legend-color.empty {background-color: #e9ecef;}\n"
        "        .conveyor {border: 2px dashed var(--cor-primaria);padding: 1rem 0.5rem;min-height: 200px;display: flex;flex-direction: column;align-items: center;text-align: center;}\n"
        "        .pallet-info {margin-top: 1rem;font-weight: bold;color: var(--cor-sucesso);}\n"
        "        .control-group {margin-bottom: 2rem;}\n"
        "        form {display: flex;flex-direction: column;gap: 0.75rem;}\n"
        "        input[type=\"text\"], input[type=\"number\"], input[type=\"date\"] {width: 100%;padding: 0.75rem;border: 1px solid var(--cor-borda);border-radius: 4px;font-size: 1rem;}\n"
        "        button {padding: 0.75rem 1rem;border: none;border-radius: 4px;background-color: var(--cor-primaria);color: white;font-size: 1rem;font-weight: bold;cursor: pointer;}\n"
        "        button:hover {opacity: 0.9;}\n"
        "        #electromagnet-control {margin-top: 1rem;display: flex;align-items: center;gap: 1rem;}\n"
        "        #log-container {background-color: #f8f9fa;border: 1px solid var(--cor-borda);border-radius: 4px;padding: 1rem;height: 150px;overflow-y: auto;font-family: \"Courier New\", monospace;font-size: 0.9rem;}\n"
        "        #log-container p {padding-bottom: 0.5rem;border-bottom: 1px solid #eee;}\n"
        "        body.dark-mode #log-container p {border-bottom-color: var(--cor-borda);}\n"
        "        #log-container p:last-child {border-bottom: none;}\n"
        "        .popup-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.5);display: none;justify-content: center;align-items: center;z-index: 1000;}\n"
        "        .popup {background-color: var(--cor-painel); padding: 2rem;border-radius: 8px;box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);text-align: center;max-width: 400px;width: 90%;}\n"
        "        .popup h3 {margin-bottom: 1rem;color: var(--cor-primaria);}\n"
        "        .popup-buttons {display: flex;gap: 1rem;justify-content: center;margin-top: 1.5rem;}\n"
        "        .popup-buttons button {padding: 0.5rem 1.5rem;}\n"
        "        .popup-buttons button.cancel {background-color: #6c757d;}\n"
        "        .popup-buttons button.cancel:hover {background-color: #5a6268;}\n"
        "    </style>\n"
        "</head>\n"
        "<body>\n"
        "    <header class=\"main-header\">\n"
        "        <h1>Painel de Controle - Armaz√©m Automatizado XYZ</h1>\n"
        "        \n"
        "        <button id=\"theme-toggle-btn\">üåô</button>\n"
        "    </header>\n"
        "\n"
        "    <main class=\"dashboard-container\">\n"
        "        <div class=\"warehouse-view-column\">\n"
        "            <section id=\"visualizacao-rack\">\n"
        "                <h2>Layout do Armaz√©m</h2>\n"
        "                <div class=\"warehouse-layout\">\n"
        "                    <div id=\"entry-conveyor\" class=\"conveyor\"><h3>Entrada</h3><div class=\"pallet-info\" id=\"pallet-on-entry\"><p>ID: ABC-123</p></div></div>\n"
        "                    <div class=\"rack-container\">\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"A1\">A1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"A2\">A2</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"A3\">A3</div>\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"A4\">A4</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"A5\">A5</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B1\">B1</div>\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"B2\">B2</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B3\">B3</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B4\">B4</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"B5\">B5</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C1\">C1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C2\">C2</div>\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"C3\">C3</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C4\">C4</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"C5\">C5</div>\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"D1\">D1</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"D2\">D2</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"D3\">D3</div>\n"
        "                        <div class=\"rack-cell occupied\" data-position=\"D4\">D4</div>\n"
        "                        <div class=\"rack-cell\" data-position=\"D5\">D5</div>\n"
        "                    </div>\n"
        "                    <div id=\"exit-conveyor\" class=\"conveyor\"><h3>Sa√≠da</h3><div class=\"pallet-info\" id=\"pallet-on-exit\"></div></div>\n"
        "                </div>\n"
        "                <div class=\"legend\">\n"
        "                    <div class=\"legend-item\"><div class=\"legend-color occupied\"></div><span>Ocupado</span></div>\n"
        "                    <div class=\"legend-item\"><div class=\"legend-color empty\"></div><span>Vazio</span></div>\n"
        "                </div>\n"
        "            </section>\n"
        "        </div>\n"
        "        <div class=\"controls-column\">\n"
        "            <section id=\"painel-controle\">\n"
        "                <h2>Painel de Controle</h2>\n"
        "                <div class=\"control-group\" id=\"pallet-operations\">\n"
        "                    <h3>Opera√ß√µes com Pallets</h3>\n"
        "                    <form id=\"store-form\"><p>Armazenar pallet da esteira de entrada.</p><button type=\"submit\">Iniciar Armazenamento</button></form>\n"
        "                    <form id=\"retrieve-form\"><label for=\"pallet-position-input\">Retirar pallet da posi√ß√£o:</label><input type=\"text\" id=\"pallet-position-input\" name=\"position\" placeholder=\"Ex: B3\" required><button type=\"submit\">Iniciar Retirada</button></form>\n"
        "                </div>\n"
        "                <div class=\"control-group\" id=\"manual-control\">\n"
        "                    <h3>Controle Manual</h3>\n"
        "                    <form id=\"move-form\"><label for=\"coord-x\">Eixo X:</label><input type=\"number\" id=\"coord-x\" name=\"x\" min=\"0\" value=\"0\"><label for=\"coord-y\">Eixo Y:</label><input type=\"number\" id=\"coord-y\" name=\"y\" min=\"0\" value=\"0\"><label for=\"coord-z\">Eixo Z:</label><input type=\"number\" id=\"coord-z\" name=\"z\" min=\"0\" value=\"0\"><button type=\"submit\">Mover para Coordenada</button></form>\n"
        "                    <div id=\"electromagnet-control\"><button id=\"electromagnet-toggle-btn\">Ativar Eletro√≠m√£</button><span>Status: <b id=\"electromagnet-status\">Desativado</b></span></div>\n"
        "                </div>\n"
        "            </section>\n"
        "            <section id=\"historico\">\n"
        "                <h2>Hist√≥rico de Movimenta√ß√µes</h2>\n"
        "                <form id=\"history-filter-form\"><label for=\"filter-date\">Filtrar por data:</label><input type=\"date\" id=\"filter-date\" name=\"date\"><button type=\"submit\">Filtrar</button></form>\n"
        "                <div id=\"log-container\"><p>15:00:12 - Pallet XYZ-789 retirado da posi√ß√£o A2.</p><p>14:58:34 - Mecanismo movido para X:150 Y:300 Z:50.</p><p>14:55:01 - Pallet ABC-123 armazenado na posi√ß√£o A5.</p></div>\n"
        "            </section>\n"
        "        </div>\n"
        "    </main>\n"
        "    <div class=\"popup-overlay\" id=\"popup-overlay\">\n"
        "        <div class=\"popup\">\n"
        "            <h3>Confirmar Remo√ß√£o</h3>\n"
        "            <p>Deseja remover o pallet da posi√ß√£o <span id=\"popup-position\"></span>?</p>\n"
        "            <div class=\"popup-buttons\"><button id=\"confirm-remove\">Sim</button><button class=\"cancel\" id=\"cancel-remove\">N√£o</button></div>\n"
        "        </div>\n"
        "    </div>\n"
        "    <footer class=\"main-footer\"><p>Interface de Controle v1.0 - Status do Sistema: <span id=\"system-status\">Online</span></p></footer>\n"
        "\n"
        "    <script>\n"
        "        const themeToggleBtn = document.getElementById('theme-toggle-btn');\n"
        "        const currentTheme = localStorage.getItem('theme');\n"
        "\n"
        "        if (currentTheme === 'dark') {\n"
        "            document.body.classList.add('dark-mode');\n"
        "            themeToggleBtn.innerHTML = '‚òÄÔ∏è';\n"
        "        }\n"
        "\n"
        "        themeToggleBtn.addEventListener('click', () => {\n"
        "            document.body.classList.toggle('dark-mode');\n"
        "            let theme = 'light';\n"
        "            if (document.body.classList.contains('dark-mode')) {\n"
        "                theme = 'dark';\n"
        "                themeToggleBtn.innerHTML = '‚òÄÔ∏è';\n"
        "            } else {\n"
        "                themeToggleBtn.innerHTML = 'üåô';\n"
        "            }\n"
        "            localStorage.setItem('theme', theme);\n"
        "        });\n"
        "\n"
        "        let historyLog = [];\n"
        "        document.addEventListener('DOMContentLoaded', function() {\n"
        "            const rackCells = document.querySelectorAll('.rack-cell');\n"
        "            const popupOverlay = document.getElementById('popup-overlay');\n"
        "            const popupPosition = document.getElementById('popup-position');\n"
        "            const confirmButton = document.getElementById('confirm-remove');\n"
        "            const cancelButton = document.getElementById('cancel-remove');\n"
        "            const electromagnetBtn = document.getElementById('electromagnet-toggle-btn');\n"
        "            const electromagnetStatus = document.getElementById('electromagnet-status');\n"
        "            let currentSlot = null;\n"
        "            let electromagnetActive = false;\n"
        "            const storeForm = document.getElementById('store-form');\n"
        "            const retrieveForm = document.getElementById('retrieve-form');\n"
        "            const moveForm = document.getElementById('move-form');\n"
        "            const filterForm = document.getElementById('history-filter-form');\n"
        "            const positionInput = document.getElementById('pallet-position-input');\n"
        "\n"
        "            initializeHistory();\n"
        "\n"
        "            rackCells.forEach(cell => {\n"
        "                cell.addEventListener('click', function() {\n"
        "                    if (this.classList.contains('occupied')) {\n"
        "                        currentSlot = this.getAttribute('data-position');\n"
        "                        popupPosition.textContent = currentSlot;\n"
        "                        popupOverlay.style.display = 'flex';\n"
        "                    }\n"
        "                });\n"
        "            });\n"
        "\n"
        "            confirmButton.addEventListener('click', function() {\n"
        "                if (currentSlot) {\n"
        "                    const slotToRemove = currentSlot;\n"
        "                    const cellElement = document.querySelector(`[data-position=\"${slotToRemove}\"]`);\n"
        "                    if (cellElement) {\n"
        "                        cellElement.classList.remove('occupied');\n"
        "                    }\n"
        "                    fetch(`/retrieve?slot=${slotToRemove}`, { method: 'POST' })\n"
        "                        .then(response => {\n"
        "                            if (response.ok) {\n"
        "                                addToHistory(`Retirada da posi√ß√£o ${slotToRemove} enviada com sucesso.`);\n"
        "                            } else {\n"
        "                                addToHistory(`ERRO ao retirar da posi√ß√£o ${slotToRemove}.`);\n"
        "                                if(cellElement) cellElement.classList.add('occupied');\n"
        "                            }\n"
        "                        })\n"
        "                        .catch(error => {\n"
        "                            console.error('Erro de conex√£o:', error);\n"
        "                            addToHistory(`ERRO de conex√£o ao retirar ${slotToRemove}.`);\n"
        "                            if(cellElement) cellElement.classList.add('occupied');\n"
        "                        });\n"
        "                }\n"
        "                popupOverlay.style.display = 'none';\n"
        "                currentSlot = null;\n"
        "            });\n"
        "\n"
        "            cancelButton.addEventListener('click', function() {\n"
        "                popupOverlay.style.display = 'none';\n"
        "                currentSlot = null;\n"
        "            });\n"
        "\n"
        "            popupOverlay.addEventListener('click', function(e) {\n"
        "                if (e.target === popupOverlay) {\n"
        "                    popupOverlay.style.display = 'none';\n"
        "                    currentSlot = null;\n"
        "                }\n"
        "            });\n"
        "\n"
        "            electromagnetBtn.addEventListener('click', function() {\n"
        "               fetch('/toggle-electromagnet', { method: 'POST' })\n"
        "                .then(response => {\n"
        "                    if (response.ok) {\n"
        "                        electromagnetActive = !electromagnetActive;\n"
        "                        const newStatus = electromagnetActive ? 'Ativado' : 'Desativado';\n"
        "                        electromagnetStatus.textContent = newStatus;\n"
        "                        electromagnetBtn.textContent = electromagnetActive ? 'Desativar Eletro√≠m√£' : 'Ativar Eletro√≠m√£';\n"
        "                        addToHistory(`Eletro√≠m√£ ${newStatus.toLowerCase()}.`);\n"
        "                    } else {\n"
        "                        addToHistory('ERRO: Falha ao comunicar com o eletro√≠m√£.');\n"
        "                    }\n"
        "                })\n"
        "                .catch(error => {\n"
        "                    addToHistory('ERRO: N√£o foi poss√≠vel conectar ao servidor.');\n"
        "                    console.error('Erro de conex√£o:', error);\n"
        "                });\n"
        "            });\n"
        "            \n"
        "            retrieveForm.addEventListener('submit', function(e) { \n"
        "                e.preventDefault();\n"
        "                const pos = positionInput.value.trim().toUpperCase();\n"
        "                if (pos) {\n"
        "                    const cellElement = document.querySelector(`[data-position=\"${pos}\"]`);\n"
        "                    if (cellElement && cellElement.classList.contains('occupied')) {\n"
        "                        cellElement.classList.remove('occupied');\n"
        "                        addToHistory(`Pallet retirado da posi√ß√£o ${pos}.`);\n"
        "                        positionInput.value = '';\n"
        "                        positionInput.setCustomValidity('');\n"
        "                    } else {\n"
        "                        positionInput.setCustomValidity('N√£o h√° um pallet nesta posi√ß√£o.');\n"
        "                        positionInput.reportValidity();\n"
        "                    }\n"
        "                }\n"
        "            });\n"
        "\n"
        "            positionInput.addEventListener('input', function() {\n"
        "                positionInput.setCustomValidity('');\n"
        "            });\n"
        "\n"
        "            storeForm.addEventListener('submit', function(e) { e.preventDefault(); addToHistory(\"Pallet armazenado da esteira de entrada.\"); });\n"
        "            moveForm.addEventListener('submit', function(e) { e.preventDefault(); const x = document.getElementById('coord-x').value; const y = document.getElementById('coord-y').value; const z = document.getElementById('coord-z').value; addToHistory(`Mecanismo movido para X:${x} Y:${y} Z:${z}.`); });\n"
        "            filterForm.addEventListener('submit', function(e) { e.preventDefault(); const date = document.getElementById('filter-date').value; if (date) { addToHistory(`Filtro aplicado para data: ${date}.`); } });\n"
        "\n"
        "            function initializeHistory() { historyLog = []; }\n"
        "\n"
        "            function addToHistory(message) {\n"
        "                const now = new Date();\n"
        "                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;\n"
        "                const logEntry = `${time} - ${message}`;\n"
        "                historyLog.unshift(logEntry);\n"
        "                updateHistoryDisplay();\n"
        "            }\n"
        "\n"
        "            function updateHistoryDisplay() {\n"
        "                const logContainer = document.getElementById('log-container');\n"
        "                logContainer.innerHTML = '';\n"
        "                historyLog.forEach(entry => {\n"
        "                    const p = document.createElement('p');\n"
        "                    p.textContent = entry;\n"
        "                    logContainer.appendChild(p);\n"
        "                });\n"
        "            }\n"
        "        });\n"
        "    </script>\n"
        "</body>\n"
        "</html>\n"
    );
}
